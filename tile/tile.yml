name: datadog
icon_file: resources/icon.png
label: Datadog Cluster Monitoring for VMware Tanzu
description: Send metrics from VMware Tanzu infrastructure to Datadog!

apply_open_security_group: false       # Apply open security group, default: false
allow_paid_service_plans: false        # Allow paid service plans, default: false

stemcell_criteria:
  os: ubuntu-xenial
  requires_cpi: false
  version: '621'

properties:
- name: author
  type: string
  label: Author
  value: Datadog

forms:
- name: datadog-config
  label: Datadog Config
  description: Datadog Configuration
  markdown: This is common configuration to both the Datadog Firehose Nozzle and the Datadog Agent
  properties:
  - name: api_key
    type: secret
    label: Datadog API Key
    description: Your Datadog API Key
  - name: site
    type: string
    label: Datadog API site
    optional: true
    description: |
      The site of the Datadog intake to send Agent data to. Set to `datadoghq.eu` to send data to the EU site.
      If unset, it defaults do `datadoghq.com`.
      If you set a URL in any of the "API URL" fields below, setting the site has no effect for that specific component, so empty it if you want to use site.
  - name: nozzle_api_url
    type: string
    optional: true
    label: Datadog API URL for Nozzle
    description: |
      The host of the Datadog intake server for the nozzle to send data to (e.g. https://api.datadoghq.com).
      If not specified, the `Datadog API URL for metrics` in the field below will be used.
  - name: nozzle_log_url
    type: string
    optional: true
    label: Datadog Log Intake URL for Nozzle
    description: |
      The host of the Datadog log intake server for the nozzle to send data to (e.g. https://agent-http-intake.logs.datadoghq.com).
      If not specified, the `Datadog API URL for logs` in the field below will be used.
  - name: api_url
    type: string
    label: Datadog API URL for metrics
    optional: true
    description: |
      The host to send metrics to (e.g. https://api.datadoghq.com).
      Use this if you need the Datadog Agent to send metrics to a custom URL, otherwise use the `site` property above.
  - name: process_dd_url
    type: string
    label: Datadog API URL for process data
    optional: true
    description: |
      The host to send process data to (e.g. https://process.datadoghq.com).
      Use this if you need the Datadog Agent to send process data to a custom URL, otherwise use the `site` property above.
  - name: apm_dd_url
    type: string
    label: Datadog API URL for APM data
    optional: true
    description: |
      The host to send APM data to (e.g. https://trace.agent.datadoghq.com).
      Use this if you need the Datadog Agent to send APM data to a custom URL, otherwise use the `site` property above.
  - name: logs_dd_url
    type: string
    label: Datadog API URL for logs
    optional: true
    description: |
      The host to send logs to (e.g. https://agent-http-intake.logs.datadoghq.com).
      Use this if you need the Datadog Agent to send logs to a custom URL, otherwise use the `site` property above.
  - name: tags
    type: string_list
    label: Tags
    description: Set custom tags, separated by a comma (e.g. foundry:myfoundry,env:production)
    optional: true
  - name: http_proxy_url
    type: string
    optional: true
    label: HTTP Proxy URL
    description: Set a URL for an http proxy
  - name: https_proxy_url
    type: string
    optional: true
    label: HTTPS Proxy URL
    description: Set a URL for an https proxy
  - name: no_proxy
    type: string_list
    optional: true
    label: No Proxy
    description: Set urls that should skip the proxy, separated by a comma (e.g. datadoghq.com,google.com,example.engineering)
  - name: no_proxy_nonexact_match
    type: boolean
    optional: true
    label: No Proxy non exact match
    description: In the Datadog Agent, enable more flexible no_proxy matching.
  - name: force_tls_12
    type: boolean
    default: false
    label: Force TLS 1.2
    description: Whether or not to force TLS 1.2 for agent HTTPS communications.

- name: additional-datadog-endpoints
  label: Additional Endpoints
  description: Additional Datadog Endpoints
  markdown: This is common additional configuration to both the Datadog Firehose Nozzle and the Datadog Agent
  properties:
  - name: additional_api_url_1
    type: string
    label: Additional Datadog API URL 1
    description: The host of the Datadog intake server to send data to (e.g. https://api.datadoghq.com)
    default: https://api.datadoghq.com
  - name: additional_api_key_1
    type: secret
    optional: true
    label: Additional Datadog API Key 1
    description: Your Datadog Additional API Key 1
  - name: additional_log_intake_url_1
    type: string
    label: Additional Datadog Log Intake URL 1
    description: The host of the Datadog log intake server to send data to (e.g. https://api.datadoghq.com)
  - name: additional_api_url_2
    type: string
    label: Additional Datadog API URL 2
    description: The host of the Datadog intake server to send data to (e.g. https://api.datadoghq.com)
    default: https://api.datadoghq.com
  - name: additional_api_key_2
    type: secret
    optional: true
    label: Additional Datadog API Key 2
    description: Your Datadog Additional API Key 2
  - name: additional_log_intake_url_2
    type: string
    label: Additional Datadog Log Intake URL 2
    description: The host of the Datadog log intake server to send data to (e.g. https://api.datadoghq.com)
  - name: additional_api_url_3
    type: string
    label: Additional Datadog API URL 3
    description: The host of the Datadog intake server to send data to (e.g. https://api.datadoghq.com)
    default: https://api.datadoghq.com
  - name: additional_api_key_3
    type: secret
    optional: true
    label: Additional Datadog API Key 3
    description: Your Datadog Additional API Key 3
  - name: additional_log_intake_url_3
    type: string
    label: Additional Datadog Log Intake URL 3
    description: The host of the Datadog log intake server to send data to (e.g. https://api.datadoghq.com)
  - name: additional_api_url_4
    type: string
    label: Additional Datadog API URL 4
    description: The host of the Datadog intake server to send data to (e.g. https://api.datadoghq.com)
    default: https://api.datadoghq.com
  - name: additional_api_key_4
    type: secret
    optional: true
    label: Additional Datadog API Key 4
    description: Your Datadog Additional API Key 4
  - name: additional_log_intake_url_4
    type: string
    label: Additional Datadog Log Intake URL 4
    description: The host of the Datadog log intake server to send data to (e.g. https://api.datadoghq.com)
  - name: additional_api_url_5
    type: string
    label: Additional Datadog API URL 5
    description: The host of the Datadog intake server to send data to (e.g. https://api.datadoghq.com)
    default: https://api.datadoghq.com
  - name: additional_api_key_5
    type: secret
    optional: true
    label: Additional Datadog API Key 5
    description: Your Datadog Additional API Key 5
  - name: additional_log_intake_url_5
    type: string
    label: Additional Datadog Log Intake URL 5
    description: The host of the Datadog log intake server to send data to (e.g. https://api.datadoghq.com)

- name: datadog-nozzle-config
  label: Datadog Firehose Nozzle Config
  description: Configure your Datadog Firehose Nozzle
  properties:
  - name: use_cluster_agent_api
    type: boolean
    label: Use Datadog Cluster Agent API
    default: false
    description: Whether or not to use the Datadog Cluster Agent API instead of the Cloud Controller API (CAPI). If enabled, requires "Serve Nozzle data" to be enabled in the Datadog Cluster Agent settings.
  - name: metric_prefix
    type: string
    label: Metric Prefix
    description: The metric prefix. Setting this to anything other than the default will have billing implications.
    optional: true
  - name: app_metrics
    type: boolean
    label: App Metrics
    default: true
    description: Grab app container metrics (e.g. cpu and memory usage).
  - name: enable_metadata_collection
    type: boolean
    label: Enable Metadata Collection
    default: false
    description: Collect application, space and organization labels and annotations to tag App Metrics.
  - name: enable_advanced_tagging
    type: boolean
    label: Enable Advanced Tagging
    default: false
    description: Send additional tags such as `sidecar_present` and `sidecar_count` for App Metrics.
  - name: metadata_keys_whitelist_patterns
    type: string_list
    label: Metadata Whitelist
    optional: true
    description: |
      Comma separated list of regular expressions.
      Label and annotation keys that match any regular expression in this list are included.
      If neither a whitelist nor a blacklist is provided, everything is included.
      If a key matches both a whitelist and a blacklist pattern, it is excluded.
  - name: metadata_keys_blacklist_patterns
    type: string_list
    label: Metadata Blacklist
    optional: true
    description: |
      Comma separated list of regular expressions.
      Label and annotation keys that match any regular expression in this list are excluded.
      If neither a whitelist nor a blacklist is provided, everything is included.
      If a key matches both a whitelist and a blacklist pattern, it is excluded.
  - name: num_workers
    type: integer
    label: Number of Worker Threads
    description: The number of worker threads to use in the nozzle
    default: 4
  - name: grab_interval
    type: integer
    label: App Metrics Interval
    description: The interval at which to grab the app metrics
    default: 10
  - name: flush_duration_seconds
    type: integer
    label: Flush Duration
    description: the interval (in seconds) to flush the collected metrics to datadog
    default: 15
  - name: flush_max_bytes
    type: integer
    label: Flush Max Bytes
    description: The maximum number of bytes to send per POST request
    default: 2097152
  - name: org_data_collection_interval
    type: integer
    label: Org Data Collection Interval
    description: The interval (in seconds) in which to submit organization metrics
    default: 600
  - name: api_batch_size
    type: integer
    label: Batch Sizes for V3 API
    description: Size of batches in which to query V3 API to populate app cache (integer between 100 and 5000)
    default: 500
    constraints:
      min: 100
      max: 5000

- name: datadog-agent-config
  label: Datadog Agent Config
  description: Configure your Datadog Agent!
  properties:
  - name: skip_ssl_validation
    type: boolean
    label: Skip SSL validation
    default: false
    description: Configure the Datadog agent to skip SSL validation
  - name: use_uuid_hostname
    type: boolean
    label: Use UUID Hostname
    default: false
    description: |
      Use the Bosh VM UUID as the hostname.
  - name: use_friendly_hostname
    type: boolean
    label: Use Friendly Hostname
    default: true
    description: |
      Generate a friendly hostname for the host, in the form `<INSTANCE_NAME>-<INSTANCE_INDEX>`.
      Check one or both of the options below (`Append VM UUID to friendly hostname` or `Make Friendly Hostname unique`) to generate unique hostnames if you have several foundations with the same deployments and/or several deployments with the same VM instances.
  - name: unique_friendly_hostname
    type: boolean
    label: Make Friendly Hostname unique
    default: false
    description: |
      Append the CloudFoundry deployment to the friendly hostname, to make it unique across deployments.
      If you have several foundations and the deployments across your foundations are not unique, check the option below (`Append VM UUID to friendly hostname`)  instead.
  - name: friendly_hostname_append_vm_guid
    type: boolean
    label: Append VM UUID to friendly hostname
    default: false
    description: |
      Append the CloudFoundry VM UUID to the friendly hostname, to make it unique.
      Set this to `true` to generate unique friendly hostnames across your entire Cloud Foundry environment.
  - name: cf_os_hostname_aliasing
    type: boolean
    label: Send OS Hostname alias
    default: false
    description: If enabled, send the OS hostname as an alias. Useful in coordination with the Friendly Hostname option.
  - name: process_agent_enabled
    label: Enable Process Agent
    type: boolean
    default: true
    description: Enable the process agent.
  - name: process_agent_containers_only
    label: Enable container collection only
    type: boolean
    default: false
    description: Enable only the container collection of the process agent. Processes are not collected.
  - name: system_probe_enabled
    label: Enable System Probe
    type: boolean
    default: false
    description: Enable the system probe.
  - name: disable_network_performance_monitoring
    type: boolean
    label: Disable Network Performance Monitoring
    default: false
    description: Disable network performance monitoring (NPM).
  - name: agent_listen_port
    type: string
    label: Agent Listen Port
    default: '17123'
    description: Change port the Agent is listening to
  - name: generate_processes
    default: true
    type: boolean
    label: Configure Process Integration
    description: Automatically generate process monitoring integration, process.yaml
  - name: generate_monit_processes
    default: true
    type: boolean
    label: Monitor Monit Processes
    description: Add monit processes to process check
  - name: collect_monit_children_processes
    default: false
    type: boolean
    label: Collect Monit Children Processes
    description: Enable the collection of monit children processes in the process check
  - name: generate_system_processes
    default: true
    type: boolean
    label: Monitor System Processes
    description: Add basic system processes to process check
  - name: generate_ntp_config
    default: true
    type: boolean
    label: Automatically Generate NTP Check
    description: Generate NTP monitoring ntp.yaml
  - name: generate_ntp_config_host
    label: NTP Check Host
    type: string
    default: "0.ubuntu.pool.ntp.org"
    description: NTP host
  - name: generate_disk_config
    label: Generate Disk Check Config
    default: true
    type: boolean
    description: Generate disk configuration, disk.yaml
  - name: generate_disk_config_tag_by_filesystem
    label: Tag By Filesystem
    default: true
    type: boolean
    description: Add tags to mountpoints by filesystem type
  - name: generate_disk_config_all_partitions
    label: Monitor All Partitions
    default: true
    type: boolean
    description: Include all partitions in the system
  - name: enable_gohai
    label: Enable Gohai
    default: true
    type: boolean
    description: Enable gohai metadata collection (default is yes)
  - name: check_runners
    type: string
    default: '1'
    label: Check Runners
    description: |
      The Agent runs workers in parallel to execute checks. By default the number of workers is set to 1.
      If set to 0 the agent will automatically determine the best number of runners needed based on the number of checks running.
      This would optimize the check collection time but may produce CPU spikes.
  - name: forwarder_num_workers
    type: string
    default: '1'
    label: Forwarder Workers
    description: |
      The number of workers used by the forwarder.
      Please note each worker will open an outbound HTTP connection towards Datadog's metrics intake at every flush.
  - name: ip_tag
    label: IP Address Tag
    type: boolean
    default: true
    description: Include a tag with the IP address of the VM
  - name: address_tag
    label: Address Tag
    type: boolean
    default: true
    description: Include a tag with the address of the VM
  - name: trace_agent
    label: Enable Trace Agent
    type: boolean
    default: true
    description: Enable the Trace Agent on all virtual machines
  - name: logs_enabled
    label: Enable Logs Agent
    type: boolean
    default: false
    description: Enable the Logs Agent on all virtual machines
  - name: strip_proc_arguments
    label: Strip process arguments
    type: boolean
    default: false
    description: This setting will strip the process arguments from the processes sent by the process agent.
  - name: secret_backend_command
    label: Secret backend command
    optional: true
    type: string
    description: Path to the executable to use to fetch secrets.
  - name: secret_backend_arguments
    label: Secret backend arguments
    optional: true
    type: string_list
    description: Comma separated list of arguments to give to the command.
  - name: secret_backend_output_max_size
    label: Secret backend output max size
    optional: true
    type: integer
    description: The size in bytes of the buffer used to store the command answer.
  - name: secret_backend_timeout
    label: Secret backend timeout
    optional: true
    type: integer
    description: The timeout to execute the command in second.
  - name: cluster_agent_poll_interval
    label: Datadog Cluster Agent poll interval
    type: integer
    default: 10
    description: How often to poll the Datadog Cluster Agent for new integration configurations (in seconds).

- name: disk-check-config
  label: Disk integration configuration
  description: Use this to fully configure and customize the disk integration.
  markdown: |
    Write here the entire YAML configuration of your configuration.
    See [the example configuration](https://github.com/DataDog/integrations-core/blob/master/disk/datadog_checks/disk/data/conf.yaml.default)
    for more details about the available options.

    Setting this will override the disk check configuration settings in the main `Datadog Agent Config` tab.
  properties:
  - name: disk_yaml_config
    label: Disk integration YAML configuration
    type: text
    optional: true
    description: Paste here the YAML configuration of the disk integration.

- name: datadog-cluster-agent-config
  label: Datadog Cluster Agent Settings
  description: Configure the Datadog Cluster Agent
  markdown: |
    The Datadog Cluster Agent enables integration autodiscovery and improved tagging for application containers and processes discovery.

    This creates an additional instance that you can configure in the `Resource Config` tab of this tile. Set the number of instances to 0 if you want to disable it.
  properties:
  - name: cluster_agent_bbs_client_identity
    configurable: false
    type: rsa_cert_credentials
    label: Autogenerated PEM-encoded client certificate and private key
    default:
      domains:
      - datadoghq.com
  - name: cluster_agent_enabled
    type: selector
    label: Enable Datadog Cluster Agent
    default: "Yes"
    description: |
      Whether or not to enable the Cluster Agent.
      If disabled, remember to set the number of instances to 0 for the `datadog-cluster-agent` job in the `Resource Config` tab.
    option_templates:
    - name: disabled_option
      select_value: "No"
      property_blueprints:
      - name: enabled_value
        type: boolean
        configurable: false
        default: false
      named_manifests:
      - name: cluster_agent_enabled
        manifest: |
          false
    - name: enabled_option
      select_value: "Yes"
      named_manifests:
      - name: cluster_agent_enabled
        manifest: |
          true
      property_blueprints:
      - name: enabled_value
        type: boolean
        configurable: false
        default: true
      - name: cluster_agent_bbs_url
        configurable: true
        type: string
        label: URL of the BBS API
        default: https://bbs.service.cf.internal:8889
        description: URL of the BBS API.
      - name: cluster_agent_locket_api
        configurable: false  # Set to true when leader election is available
        type: string
        label: Locket API location
        default: locket.service.cf.internal:8891
        description: Locket API location
      - name: cluster_agent_bbs_poll_interval
        configurable: true
        type: integer
        label: Polling interval of the BBS API
        default: 15
        description: Interval for refreshing autodiscovery data from BBS API (in seconds).
      - name: cluster_agent_ulimit_files
        configurable: true
        type: integer
        label: The limit of open file descriptors for the cluster agent process.
        default: 1024
        description:  Increase if you have a large number of VMs in your environmnent, to allow more HTTP connections to the cluster agent API.
      - name: cluster_agent_bbs_ca_crt
        optional: true
        configurable: true
        type: ca_certificate
        label: PEM-encoded CA certificate (leave blank to fill automatically)
        description: |-
          PEM-encoded CA certificate for the BBS API communication.
          Used to verify the identity specified in the input below.
          Needs to be trusted by the BBS API server.
      - name: cluster_agent_bbs_client_identity
        optional: true
        configurable: true
        type: rsa_cert_credentials
        label: PEM-encoded client certificate and private key (leave both fields blank to fill automatically)
        description: |-
          PEM-encoded client certificate and private key for the BBS API communication.
          The automatic generation for this uses the OpsManager Root CA, which should be specified in the input above.
      - name: cluster_agent_warmup_duration
        configurable: true
        type: integer
        label: Warmup duration
        default: 30
        description: Number of seconds to wait for Node agents to report before starting to dispatch configurations.
      - name: cluster_agent_log_level
        configurable: true
        type: string
        label: Log level
        default: INFO
        description: Logging level for the cluster agent.
      - name: cluster_agent_token
        configurable: true
        type: secret
        label: Authentication token
        constraints:
        - must_match_regex: '^.{32,}$'
          error_message: 'This token must be at least 32 characters long'
        description: Token for Node Agent <-> Cluster Agent authentication. String of 32 characters or more.
      - name: cluster_agent_port
        configurable: true
        type: port
        label: Cluster Agent port
        default: 5005
        description: Port on which the Cluster Agent can be reached by Node Agents.
      - name: cluster_agent_serve_nozzle_data
        configurable: true
        type: boolean
        label: Serve Nozzle data
        default: false
        description: Whether or not to serve preprocessed data for the nozzles.
      - name: cluster_agent_advanced_tagging
        configurable: true
        type: boolean
        label: Enable Advanced Tagging
        default: false
        description: Whether or not to collect extra tags such as `sidecar_present` and `sidecar_count` for containers.
      - name: enable_cloud_foundry_api_apps_polling
        configurable: true
        type: boolean
        label: Enable Cloud Foundry API apps polling
        default: false
        description: Whether or not to poll the apps endpoint of the Cloud Foundry API for improved tagging functionality of containers.
      - name: cloud_foundry_api_poll_interval
        configurable: true
        type: integer
        label: Polling interval of the Cloud Foundry API
        default: 60
        description: Polling rate of CC API, in seconds. Low values might influence performance of other operations in the cluster.
      - name: cloud_foundry_api_apps_batch_size
        configurable: true
        type: integer
        label: Batch size of CC API list applications endpoint
        default: 5000
        description: Number of apps per page to collect when calling the list apps endpoint of the CC API. Max 5000.
      - name: enable_cloud_foundry_api_check
        configurable: true
        type: boolean
        label: Enable Cloud Foundry API Integration
        default: false
        description: Whether or not to enable and configure the Cloud Foundry API integration to collect audit events.
      - name: cloud_foundry_api_check_event_filter
        configurable: true
        type: string_list
        label: List of events to collect
        default: audit.app.restage,audit.app.update,audit.app.create,app.crash
        description: Comma separated list of Cloud Foundry audit events to collect.
      - name: cloud_foundry_bbs_env_include
        optional: true
        configurable: true
        type: string_list
        label: Application environment variables include patterns
        description: List of regular expressions to allow a set of environment variables to be included as container tags.
      - name: cloud_foundry_bbs_env_exclude
        optional: true
        configurable: true
        type: string_list
        label: Application environment variables exclude patterns
        description: List of regular expressions to forbid a set of environment variables to be included as container tags.

- name: cf-config
  label: Cloud Foundry Settings
  description: Cloud Foundry connection details
  markdown: |
    A [UAA Client and Secret](https://docs.pivotal.io/pivotalcf/uaa/uaa-user-management.html) is required to use the datadog firehose nozzle
    Failing to specify the API user on versions without `datadog-firehose` will result in:

    ```
    unknown property "datadog_firehose_credentials"...
    ```

    See the docs for detailed instructions on creating a user.
  properties:
  - name: insecure_ssl_skip_verify
    type: boolean
    label: Skip SSL validation
    default: false
    description: Skip SSL validation (to allow things like self-signed certs). Do not set to true in production.
  - name: disable_access_control
    type: boolean
    label: Disable Access Control
    default: false
    description: Disable Access Control
  - name: uaa_client
    type: string
    label: UAA Client
    description: UAA client (a user having both "cloud_controller.admin_read_only" and "doppler.firehose")
    optional: false
  - name: uaa_secret
    type: secret
    label: UAA Secret
    description: Secret for the UAA Client
    optional: false
  - name: firehose_subscription_id
    type: string
    label: Firehose subscription id
    default: datadog-firehose-subscription-id
    description: Subscription id unique to nozzle; firehose balances across socket connections having same id.

- name: inclusion-rules
  label: Inclusion placement Rules
  description: Datadog Agent inclusion placement rules
  markdown: See [Bosh documentation for placement rules](https://bosh.io/docs/runtime-config/#placement-rules). This form configures the `include` rules.
  properties:
    - name: include_stemcell
      type: collection
      label: Stemcell inclusion rules
      description: Default is to target only and all linux VMs, windows is not supported.
      configurable: true
      default:
        - os: ubuntu-xenial
        - os: ubuntu-trusty
        - os: centos-7
      property_blueprints:
        - name: os
          type: string
          configurable: true
          label: OS to match
      named_manifests:
        - name: stemcell
          manifest: |
            os: (( current_record.os.value ))
    - name: include_deployments
      label: Deployments inclusion rules
      type: collection
      optional: true
      configurable: true
      property_blueprints:
        - name: deployment
          type: string
          configurable: true
          label: Deployment to match
      named_manifests:
        - name: deployments
          manifest: (( current_record.deployment.value ))
    - name: include_jobs
      type: collection
      label: Jobs inclusion rules
      optional: true
      configurable: true
      property_blueprints:
        - name: name
          type: string
          configurable: true
          label: Name of the job to match
        - name: release
          type: string
          configurable: true
          label: Release to match
      named_manifests:
        - name: jobs
          manifest: |
            name: (( current_record.name.value ))
            release: (( current_record.release.value ))
    - name: include_instance_groups
      label: Instance Groups inclusion rules
      type: collection
      optional: true
      configurable: true
      property_blueprints:
        - name: instance_group
          type: string
          configurable: true
          label: Instance group to match
      named_manifests:
        - name: instance_groups
          manifest: (( current_record.instance_group.value ))
    - name: include_networks
      label: Networks inclusion rules
      type: collection
      optional: true
      configurable: true
      property_blueprints:
        - name: network
          type: string
          configurable: true
          label: Network to match
      named_manifests:
        - name: networks
          manifest: (( current_record.network.value ))
    - name: include_teams
      label: Teams inclusion rules
      type: collection
      optional: true
      configurable: true
      property_blueprints:
        - name: team
          type: string
          configurable: true
          label: Team to match
      named_manifests:
        - name: teams
          manifest: (( current_record.team.value ))
    - name: include_lifecycle
      label: Lifecyle inclusion rule
      type: string
      optional: true
      configurable: true

- name: exclusion-rules
  label: Exclusion placement Rules
  description: Datadog Agent exclusion placement rules
  markdown: See [Bosh documentation for placement rules](https://bosh.io/docs/runtime-config/#placement-rules). This form configures the `exclude` rules.
  properties:
    - name: exclude_stemcell
      type: collection
      label: Stemcell exclusion rules
      configurable: true
      optional: true
      property_blueprints:
        - name: os
          type: string
          configurable: true
          label: OS to match
      named_manifests:
        - name: stemcell
          manifest: |
            os: (( current_record.os.value ))
    - name: exclude_deployments
      label: Deployments exclusion rules
      type: collection
      optional: true
      configurable: true
      property_blueprints:
        - name: deployment
          type: string
          configurable: true
          label: Deployment to match
      named_manifests:
        - name: deployments
          manifest: (( current_record.deployment.value ))
    - name: exclude_jobs
      type: collection
      label: Jobs exclusion rules
      description: |
        Default is to exclude both `kube-scheduler` and `kubelet` jobs of the `kubo` release to avoid installing on kubernetes instances if the TKGI tile is installed.
        Another Datadog Agent addon already gets installed on TKGI VMs via this tile.
      default:
        - name: kube-scheduler
          release: kubo
        - name: kubelet
          release: kubo
      configurable: true
      property_blueprints:
        - name: name
          type: string
          configurable: true
          label: Name of the job to match
        - name: release
          type: string
          configurable: true
          label: Release to match
      named_manifests:
        - name: jobs
          manifest: |
            name: (( current_record.name.value ))
            release: (( current_record.release.value ))
    - name: exclude_instance_groups
      label: Instance Groups exclusion rules
      type: collection
      optional: true
      configurable: true
      property_blueprints:
        - name: instance_group
          type: string
          configurable: true
          label: Instance group to match
      named_manifests:
        - name: instance_groups
          manifest: (( current_record.instance_group.value ))
    - name: exclude_networks
      label: Networks exclusion rules
      type: collection
      optional: true
      configurable: true
      property_blueprints:
        - name: network
          type: string
          configurable: true
          label: Network to match
      named_manifests:
        - name: networks
          manifest: (( current_record.network.value ))
    - name: exclude_teams
      label: Teams exclusion rules
      type: collection
      optional: true
      configurable: true
      property_blueprints:
        - name: team
          type: string
          configurable: true
          label: Team to match
      named_manifests:
        - name: teams
          manifest: (( current_record.team.value ))
    - name: exclude_lifecycle
      label: Lifecyle exclusion rule
      type: string
      optional: true
      configurable: true

packages:
- name: datadog-firehose-nozzle-release
  type: bosh-release
  path: resources/datadog-firehose-nozzle-release.tgz
  jobs:
  - name: datadog-firehose-nozzle
    templates:
    - name: datadog-firehose-nozzle
      release: datadog-firehose-nozzle
    dynamic_ip: 1
    instances: 1
    properties:
      datadog:
        api_key: (( .properties.api_key.value ))
        api_url: (( .properties.nozzle_api_url.value || .properties.api_url.value ))
        log_intake_url: (( .properties.nozzle_log_url.value || .properties.logs_dd_url.value ))
        additional_api_key_1: (( .properties.additional_api_key_1.value ))
        additional_api_url_1: (( .properties.additional_api_url_1.value ))
        additional_log_intake_url_1: (( .properties.additional_log_intake_url_1.value ))
        additional_api_key_2: (( .properties.additional_api_key_2.value ))
        additional_api_url_2: (( .properties.additional_api_url_2.value ))
        additional_log_intake_url_2: (( .properties.additional_log_intake_url_2.value ))
        additional_api_key_3: (( .properties.additional_api_key_3.value ))
        additional_api_url_3: (( .properties.additional_api_url_3.value ))
        additional_log_intake_url_3: (( .properties.additional_log_intake_url_3.value ))
        additional_api_key_4: (( .properties.additional_api_key_4.value ))
        additional_api_url_4: (( .properties.additional_api_url_4.value ))
        additional_log_intake_url_4: (( .properties.additional_log_intake_url_4.value ))
        additional_api_key_5: (( .properties.additional_api_key_5.value ))
        additional_api_url_5: (( .properties.additional_api_url_5.value ))
        additional_log_intake_url_5: (( .properties.additional_log_intake_url_5.value ))
        metric_prefix: (( .properties.metric_prefix.value ))
        custom_tags: (( .properties.tags.value ))
        flush_max_bytes: (( .properties.flush_max_bytes.value ))
        flush_duration_seconds: (( .properties.flush_duration_seconds.value ))
      nozzle:
        insecure_ssl_skip_verify: (( .properties.insecure_ssl_skip_verify.value ))
        disable_access_control: (( .properties.disable_access_control.value ))
        subscription_id: (( .properties.firehose_subscription_id.value ))
        deployment: (( name ))
        app_metrics: (( .properties.app_metrics.value ))
        num_workers: (( .properties.num_workers.value ))
        grab_interval: (( .properties.grab_interval.value ))
        org_data_collection_interval: (( .properties.org_data_collection_interval.value ))
        http_proxy_url: (( .properties.http_proxy_url.value ))
        https_proxy_url: (( .properties.https_proxy_url.value ))
        no_proxy: (( .properties.no_proxy.value ))
        enable_metadata_collection: (( .properties.enable_metadata_collection.value ))
        metadata_keys_whitelist_patterns: (( .properties.metadata_keys_whitelist_patterns.parsed_strings ))
        metadata_keys_blacklist_patterns: (( .properties.metadata_keys_blacklist_patterns.parsed_strings ))
        dca_enabled: (( .properties.use_cluster_agent_api.value ))
        dca_url: https://datadog-cluster-agent.(( ..datadog.deployment_name ))
        dca_port: (( .properties.cluster_agent_enabled.enabled_option.cluster_agent_port.value ))
        dca_token: (( .properties.cluster_agent_enabled.enabled_option.cluster_agent_token.value ))
        enable_advanced_tagging: (( .properties.enable_advanced_tagging.value ))
      uaa:
        client: (( .properties.uaa_client.value ))
        client_secret: (( .properties.uaa_secret.value ))
        url: https://uaa.(( ..cf.cloud_controller.system_domain.value ))
      cc:
        endpoint: https://api.(( ..cf.cloud_controller.system_domain.value ))
        api_batch_size: (( .properties.api_batch_size.value ))

- name: datadog-cluster-agent-boshrelease
  type: bosh-release
  path: resources/datadog-cluster-agent-boshrelease.tgz
  jobs:
  - name: datadog-cluster-agent
    templates:
    - name: datadog-cluster-agent
      release: datadog-cluster-agent
      provides:
        datadog-cluster-agent:
          aliases:
          - domain: datadog-cluster-agent.(( ..datadog.deployment_name ))
    dynamic_ip: 1
    instances: 1
    properties:
      cluster_agent:
        force_tls_12: (( .properties.force_tls_12.value ))
        bbs_url: (( .properties.cluster_agent_enabled.enabled_option.cluster_agent_bbs_url.value ))
        locket_api_location: (( .properties.cluster_agent_enabled.enabled_option.cluster_agent_locket_api.value ))
        bbs_poll_interval: (( .properties.cluster_agent_enabled.enabled_option.cluster_agent_bbs_poll_interval.value ))
        ulimit_files: (( .properties.cluster_agent_enabled.enabled_option.cluster_agent_ulimit_files.value ))
        bbs_ca_crt: (( .properties.cluster_agent_enabled.enabled_option.cluster_agent_bbs_ca_crt.value || $ops_manager.ca_certificate ))
        bbs_client_crt: (( .properties.cluster_agent_enabled.enabled_option.cluster_agent_bbs_client_identity.cert_pem || .properties.cluster_agent_bbs_client_identity.cert_pem ))
        bbs_client_key: (( .properties.cluster_agent_enabled.enabled_option.cluster_agent_bbs_client_identity.private_key_pem || .properties.cluster_agent_bbs_client_identity.private_key_pem ))
        warmup_duration: (( .properties.cluster_agent_enabled.enabled_option.cluster_agent_warmup_duration.value ))
        log_level: (( .properties.cluster_agent_enabled.enabled_option.cluster_agent_log_level.value ))
        token: (( .properties.cluster_agent_enabled.enabled_option.cluster_agent_token.value ))
        port: (( .properties.cluster_agent_enabled.enabled_option.cluster_agent_port.value ))
        enabled: (( .properties.cluster_agent_enabled.selected_option.parsed_manifest(cluster_agent_enabled) ))
        enable_cloud_foundry_api_check: (( .properties.cluster_agent_enabled.enabled_option.enable_cloud_foundry_api_check.value ))
        enable_cloud_foundry_api_apps_polling: (( .properties.cluster_agent_enabled.enabled_option.enable_cloud_foundry_api_apps_polling.value ))
        serve_nozzle_data: (( .properties.cluster_agent_enabled.enabled_option.cluster_agent_serve_nozzle_data.value ))
        advanced_tagging: (( .properties.cluster_agent_enabled.enabled_option.cluster_agent_advanced_tagging.value ))
      cloud_foundry_api:
        api_url: https://api.(( ..cf.cloud_controller.system_domain.value ))
        poll_interval: (( .properties.cluster_agent_enabled.enabled_option.cloud_foundry_api_poll_interval.value ))
        apps_batch_size: (( .properties.cluster_agent_enabled.enabled_option.cloud_foundry_api_apps_batch_size.value ))
        client_id: (( .properties.uaa_client.value ))
        client_secret: (( .properties.uaa_secret.value ))
        event_filter: (( .properties.cluster_agent_enabled.enabled_option.cloud_foundry_api_check_event_filter.parsed_strings ))
        tags: (( .properties.tags.parsed_strings ))
        skip_ssl_validation: (( .properties.insecure_ssl_skip_verify.value ))
        https_proxy: (( .properties.https_proxy_url.value ))
        http_proxy: (( .properties.http_proxy_url.value ))
        no_proxy: (( .properties.no_proxy.parsed_strings ))
      cloud_foundry_bbs:
        env_include: (( .properties.cluster_agent_enabled.enabled_option.cloud_foundry_bbs_env_include.parsed_strings))
        env_exclude: (( .properties.cluster_agent_enabled.enabled_option.cloud_foundry_bbs_env_exclude.parsed_strings))

- name: datadog-agent-boshrelease
  type: bosh-release
  path: resources/datadog-agent-boshrelease.tgz


runtime_configs:
- name: datadog-agent
  runtime_config:
    releases:
    - name: datadog-agent
      version: "4.10.0"     # Update this if update the agent
    addons:
    - name: datadog
      include:
        stemcell: (( .properties.include_stemcell.parsed_manifest(stemcell) ))
        deployments: (( .properties.include_deployments.parsed_manifest(deployments) ))
        jobs: (( .properties.include_jobs.parsed_manifest(jobs) ))
        instance_groups: (( .properties.include_instance_groups.parsed_manifest(instance_groups) ))
        networks: (( .properties.include_networks.parsed_manifest(networks) ))
        teams: (( .properties.include_teams.parsed_manifest(teams) ))
        lifecycle: (( .properties.include_lifecycle.value || "" ))
      exclude:
        stemcell: (( .properties.exclude_stemcell.parsed_manifest(stemcell) ))
        deployments: (( .properties.exclude_deployments.parsed_manifest(deployments) ))
        jobs: (( .properties.exclude_jobs.parsed_manifest(jobs) ))
        instance_groups: (( .properties.exclude_instance_groups.parsed_manifest(instance_groups) ))
        networks: (( .properties.exclude_networks.parsed_manifest(networks) ))
        teams: (( .properties.exclude_teams.parsed_manifest(teams) ))
        lifecycle: (( .properties.exclude_lifecycle.value || "" ))
      jobs:
      - name: dd-agent
        release: datadog-agent
      properties:
        dd:
          skip_ssl_validation: (( .properties.skip_ssl_validation.value ))
          use_dogstatsd: yes
          dogstatsd_port: 18125   # Many Cloud Foundry deployments have their own StatsD listening on port 8125
          api_key: (( .properties.api_key.value ))
          additional_api_key_1: (( .properties.additional_api_key_1.value ))
          additional_api_url_1: (( .properties.additional_api_url_1.value ))
          additional_api_key_2: (( .properties.additional_api_key_2.value ))
          additional_api_url_2: (( .properties.additional_api_url_2.value ))
          additional_api_key_3: (( .properties.additional_api_key_3.value ))
          additional_api_url_3: (( .properties.additional_api_url_3.value ))
          additional_api_key_4: (( .properties.additional_api_key_4.value ))
          additional_api_url_4: (( .properties.additional_api_url_4.value ))
          additional_api_key_5: (( .properties.additional_api_key_5.value ))
          additional_api_url_5: (( .properties.additional_api_url_5.value ))
          friendly_hostname: (( .properties.use_friendly_hostname.value ))
          unique_friendly_hostname: (( .properties.unique_friendly_hostname.value ))
          friendly_hostname_append_vm_guid: (( .properties.friendly_hostname_append_vm_guid.value ))
          cf_os_hostname_aliasing: (( .properties.cf_os_hostname_aliasing.value ))
          tags: (( .properties.tags.value ))
          proxy:
            http: (( .properties.http_proxy_url.value ))
            https: (( .properties.https_proxy_url.value ))
            no_proxy: (( .properties.no_proxy.value ))
          no_proxy_nonexact_match: (( .properties.no_proxy_nonexact_match.value ))
          force_tls_12: (( .properties.force_tls_12.value ))
          url: (( .properties.api_url.value ))
          process_dd_url: (( .properties.process_dd_url.value ))
          apm_dd_url: (( .properties.apm_dd_url.value ))
          logs_dd_url: (( .properties.logs_dd_url.value ))
          site: (( .properties.site.value ))
          use_uuid_hostname: (( .properties.use_uuid_hostname.value ))
          process_agent_enabled: (( .properties.process_agent_enabled.value ))
          process_agent_containers_only: (( .properties.process_agent_containers_only.value ))
          system_probe_enabled: (( .properties.system_probe_enabled.value ))
          disable_network_performance_monitoring: (( .properties.disable_network_performance_monitoring.value ))
          agent_listen_port: (( .properties.agent_listen_port.value ))
          generate_processes: (( .properties.generate_processes.value ))
          generate_monit_processes: (( .properties.generate_monit_processes.value ))
          collect_monit_children_processes: (( .properties.collect_monit_children_processes.value ))
          generate_system_processes: (( .properties.generate_system_processes.value ))
          generate_ntp_config: (( .properties.generate_ntp_config.value ))
          generate_ntp_config_host: (( .properties.generate_ntp_config_host.value ))
          generate_disk_config: (( .properties.generate_disk_config.value ))
          generate_disk_config_tag_by_filesystem: (( .properties.generate_disk_config_tag_by_filesystem.value ))
          generate_disk_config_all_partitions: (( .properties.generate_disk_config_all_partitions.value ))
          disk_yaml_config: (( .properties.disk_yaml_config.value ))
          enable_gohai: (( .properties.enable_gohai.value ))
          check_runners: (( .properties.check_runners.value ))
          forwarder_num_workers: (( .properties.forwarder_num_workers.value ))
          ip_tag: (( .properties.ip_tag.value ))
          address_tag: (( .properties.address_tag.value ))
          trace_agent_enabled: (( .properties.trace_agent.value ))
          enable_logs_agent: (( .properties.logs_enabled.value ))
          strip_proc_arguments: (( .properties.strip_proc_arguments.value ))
          secret_backend_command: (( .properties.secret_backend_command.value ))
          secret_backend_arguments: (( .properties.secret_backend_arguments.parsed_strings ))
          secret_backend_output_max_size: (( .properties.secret_backend_output_max_size.value ))
          secret_backend_timeout: (( .properties.secret_backend_timeout.value ))
          cluster_agent_poll_interval: (( .properties.cluster_agent_poll_interval.value ))
        cluster_agent:
          token: (( .properties.cluster_agent_enabled.enabled_option.cluster_agent_token.value ))
          port: (( .properties.cluster_agent_enabled.enabled_option.cluster_agent_port.value ))
          enabled: (( .properties.cluster_agent_enabled.selected_option.parsed_manifest(cluster_agent_enabled) ))
          address: datadog-cluster-agent.(( ..datadog.deployment_name ))

- name: datadog-agent-kube-control-plan
  runtime_config:
    releases:
    - name: datadog-agent
      version: "4.10.0"     # Update this if update the agent
    addons:
    - name: datadog
      include:
        jobs:
        # Include kubernetes master nodes
        - name: kube-scheduler
          release: kubo
      jobs:
      - name: dd-agent
        release: datadog-agent
      properties:
        dd:
          skip_ssl_validation: (( .properties.skip_ssl_validation.value ))
          use_dogstatsd: yes
          dogstatsd_port: 18125   # Many Cloud Foundry deployments have their own StatsD listening on port 8125
          api_key: (( .properties.api_key.value ))
          additional_api_key_1: (( .properties.additional_api_key_1.value ))
          additional_api_url_1: (( .properties.additional_api_url_1.value ))
          additional_api_key_2: (( .properties.additional_api_key_2.value ))
          additional_api_url_2: (( .properties.additional_api_url_2.value ))
          additional_api_key_3: (( .properties.additional_api_key_3.value ))
          additional_api_url_3: (( .properties.additional_api_url_3.value ))
          additional_api_key_4: (( .properties.additional_api_key_4.value ))
          additional_api_url_4: (( .properties.additional_api_url_4.value ))
          additional_api_key_5: (( .properties.additional_api_key_5.value ))
          additional_api_url_5: (( .properties.additional_api_url_5.value ))
          friendly_hostname: (( .properties.use_friendly_hostname.value ))
          friendly_hostname_append_vm_guid: (( .properties.friendly_hostname_append_vm_guid.value ))
          unique_friendly_hostname: (( .properties.unique_friendly_hostname.value ))
          cf_os_hostname_aliasing: (( .properties.cf_os_hostname_aliasing.value ))
          tags: (( .properties.tags.value ))
          proxy:
            http: (( .properties.http_proxy_url.value ))
            https: (( .properties.https_proxy_url.value ))
            no_proxy: (( .properties.no_proxy.value ))
          no_proxy_nonexact_match: (( .properties.no_proxy_nonexact_match.value ))
          force_tls_12: (( .properties.force_tls_12.value ))
          url: (( .properties.api_url.value ))
          process_dd_url: (( .properties.process_dd_url.value ))
          apm_dd_url: (( .properties.apm_dd_url.value ))
          logs_dd_url: (( .properties.logs_dd_url.value ))
          site: (( .properties.site.value ))
          use_uuid_hostname: (( .properties.use_uuid_hostname.value ))
          process_agent_enabled: (( .properties.process_agent_enabled.value ))
          process_agent_containers_only: (( .properties.process_agent_containers_only.value ))
          system_probe_enabled: (( .properties.system_probe_enabled.value ))
          disable_network_performance_monitoring: (( .properties.disable_network_performance_monitoring.value ))
          agent_listen_port: (( .properties.agent_listen_port.value ))
          generate_processes: (( .properties.generate_processes.value ))
          generate_monit_processes: (( .properties.generate_monit_processes.value ))
          collect_monit_children_processes: (( .properties.collect_monit_children_processes.value ))
          generate_system_processes: (( .properties.generate_system_processes.value ))
          generate_ntp_config: (( .properties.generate_ntp_config.value ))
          generate_ntp_config_host: (( .properties.generate_ntp_config_host.value ))
          generate_disk_config: (( .properties.generate_disk_config.value ))
          generate_disk_config_tag_by_filesystem: (( .properties.generate_disk_config_tag_by_filesystem.value ))
          generate_disk_config_all_partitions: (( .properties.generate_disk_config_all_partitions.value ))
          disk_yaml_config: (( .properties.disk_yaml_config.value ))
          enable_gohai: (( .properties.enable_gohai.value ))
          check_runners: (( .properties.check_runners.value ))
          forwarder_num_workers: (( .properties.forwarder_num_workers.value ))
          ip_tag: (( .properties.ip_tag.value ))
          address_tag: (( .properties.address_tag.value ))
          trace_agent_enabled: (( .properties.trace_agent.value ))
          enable_logs_agent: (( .properties.logs_enabled.value ))
          strip_proc_arguments: (( .properties.strip_proc_arguments.value ))
          secret_backend_command: (( .properties.secret_backend_command.value ))
          secret_backend_arguments: (( .properties.secret_backend_arguments.parsed_strings ))
          secret_backend_output_max_size: (( .properties.secret_backend_output_max_size.value ))
          secret_backend_timeout: (( .properties.secret_backend_timeout.value ))
          cluster_agent_poll_interval: (( .properties.cluster_agent_poll_interval.value ))
          integrations:
            etcd:
              init_config: {}
              instances:
              - prometheus_url: https://localhost:2379/metrics
                tls_verify: false
                tls_cert: /var/vcap/jobs/etcd/config/etcd.crt
                tls_private_key: /var/vcap/jobs/etcd/config/etcd.key
            kube_apiserver_metrics:
              init_config: {}
              instances:
              - prometheus_url: http://localhost:8080/metrics
                bearer_token_auth: false
            kube_controller_manager:
              init_config: {}
              instances:
              - prometheus_url: http://localhost:10252/metrics
                leader_election: false
            kube_scheduler:
              init_config: {}
              instances:
              - prometheus_url: http://localhost:10251/metrics
                leader_election: false
        cluster_agent:
          token: (( .properties.cluster_agent_enabled.enabled_option.cluster_agent_token.value ))
          port: (( .properties.cluster_agent_enabled.enabled_option.cluster_agent_port.value ))
          enabled: (( .properties.cluster_agent_enabled.selected_option.parsed_manifest(cluster_agent_enabled) ))
          address: datadog-cluster-agent.(( ..datadog.deployment_name ))
